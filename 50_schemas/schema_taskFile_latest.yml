# Task File Schema v2.0
# Defines the structure and validation rules for task definition files

metadata:
  name: Task File Schema
  version: 2.2.0
  date: 2025-12-19
  status: active
  description: Schema for req_XXXX_{target}_{slug}.md task definition files
  used_by: protocol_taskCoordination_latest.yml
  changes_from_v2.1:
    - target_worker moved from optional field to filename pattern
    - Agent filtering via glob pattern (ls *_{target}_*.yml)

file_naming:
  pattern: req_XXXX_{target}_{slug}.md
  components:
    req: Literal prefix
    XXXX: 4-digit zero-padded task ID (e.g., 1001, 1002)
    target: Target worker (librarian, dev-lead, custodian, ops, any, cli)
    slug: Kebab-case task description (e.g., system-info, yaml-review)
    extension: .md (Markdown) or .yml (YAML)
  target_values:
    librarian: Librarian agent (ai_memories pipeline)
    dev-lead: Dev Lead agent (todos, task creation)
    custodian: Custodian agent (filesystem hygiene)
    ops: Ops agent (task execution)
    any: Any available agent may claim
    cli: General CLI instance (non-specialized)
  examples:
    - req_0042_librarian_process_exports.yml
    - req_0043_custodian_fix_symlinks.yml
    - req_0044_dev-lead_review_backlog.yml
    - req_0045_ops_verify_daemon.yml
    - req_0046_any_update_readme.yml
    - req_0047_cli_adhoc_task.md
  agent_filtering: "ls *_{target}_*.yml  # e.g., ls *_librarian_*.yml"

folder_naming:
  pattern: req_XXXX_{target}_{slug}/
  matches: Task filename without extension
  claimed_pattern: claimed_{timestamp}_{pid}_req_XXXX_{target}_{slug}/
  timestamp_format: YYYYMMDD_HHMMSS
  examples:
    - req_0042_librarian_process_exports/
    - claimed_20251219_143022_12345_req_0042_librarian_process_exports/

task_id_allocation:
  source_file: _NNNN_next_req_id
  location: Coordination root directory
  format: Plain text file containing next available ID
  increment: After successful task creation

# =============================================================================
# REQUIRED FIELDS
# =============================================================================

required_fields:
  title:
    format: "# Request #XXXX: Title"
    description: Markdown H1 header with request ID and descriptive title
    validation: Must match req_XXXX pattern in filename
    example: "# Request #1001: System Information Report"
  
  type:
    format: "**Type:** {value}"
    allowed_values:
      - Standard       # Normal task execution
      - Research       # Information gathering, analysis
      - Installation   # Software/tool installation
      - Testing        # Test execution, validation
      - Emergency      # Urgent, bypass normal queue
      - Maintenance    # Cleanup, organization, updates
    default: Standard
  
  priority:
    format: "**Priority:** {value}"
    allowed_values:
      - LOW            # Can wait, do when convenient
      - NORMAL         # Standard priority (default)
      - HIGH           # Should be done soon
      - URGENT         # Do next, interrupt lower priority
      - CRITICAL       # Drop everything, do now
    default: NORMAL
  
  posted:
    format: "**Posted:** {ISO 8601 timestamp}"
    description: When the task was created
    example: "**Posted:** 2025-11-23T15:30:00-06:00"
  
  description:
    format: "## Task Description\n{markdown content}"
    description: What needs to be done, context, requirements
    minimum_length: 1 sentence

  expected_response:
    format: "## Expected Response\n{description}"
    description: What the Worker should return/produce
    purpose: Sets clear completion criteria

# =============================================================================
# OPTIONAL FIELDS
# =============================================================================

optional_fields:
  commands:
    format: "## Task Commands\n```bash\n{commands}\n```"
    description: Specific bash commands to execute
    when_omitted: Worker determines appropriate commands
  
  discrete:
    format: "**Discrete:** true|false"
    description: If true, task should not be subdivided
    default: false (subdivision allowed)
  
  target_worker:
    format: "**Target Worker:** {worker_type} or {worker_type}:{pid}"
    description: DEPRECATED - use filename pattern instead (req_XXXX_{target}_{slug}.md)
    status: deprecated_v2.2
    migration: Move target to filename, e.g., req_0042_librarian_process_exports.yml
    when_present: Still honored for backward compatibility
  
  session:
    format: "**Session:** {session_name} or {session_id}"
    description: Persistent session for agent expertise accumulation
    purpose: |
      Specifies which persistent agent session should handle this task.
      Enables expertise accumulation across multiple task executions.
    value_types:
      session_name: "Human-readable name from session_registry.yml (e.g., librarian-001)"
      session_id: "UUID for the session"
    examples:
      - "**Session:** librarian-001"
      - "**Session:** custodian-001"
      - "**Session:** reviewer-001"
      - "**Session:** 257c13b3-c315-479e-86fc-eed05cb90a0d"
    registry: "~/.claude/session_registry.yml"
    when_omitted: Task runs in ephemeral session (fresh context)
    launch_pattern: "claude --project {project} --session-id {session} \"{prompt}\""
    use_cases:
      persistent:
        - "Role-based agents (Librarian, Custodian, Reviewer)"
        - "Long-running projects requiring context continuity"
        - "Tasks that build on prior work in same domain"
      ephemeral:
        - "One-off tasks"
        - "Parallel workers on same task type"
        - "Experiments or explorations"
        - "When fresh perspective is valuable"
  
  entry_criteria:
    format: "## Entry Criteria\n{list of conditions}"
    description: Prerequisites that must be met before starting
    when_omitted: Task can start immediately when claimed
  
  exit_criteria:
    format: "## Exit Criteria\n{list of conditions}"
    description: Conditions that define successful completion
    when_omitted: Worker judgment determines completion
  
  depends_on:
    format: "**Depends On:** req_XXXX, req_YYYY"
    description: Task IDs that must complete before this task starts
    status: "WALK STAGE - for Task Sets"

  sequence_id:
    format: "**Sequence:** {NNN}"
    description: Order within a Task Set (001, 002, etc.)
    status: "WALK STAGE - for Task Sets"
  
  notes:
    format: "## Notes\n{additional context}"
    description: Any additional information for the Worker
    examples:
      - Background context
      - Related tasks
      - Known issues to watch for

  subtasks:
    format: |
      ## Subtasks
      - {subtask_id}: {short description}
    description: |
      Optional list of planned child tasks. Use Task Coordination Protocol v7.0
      naming (`{parent}_t{N}` or `{parent}_t{N}.{M}`) and include brief intent.
    value_type: list
    when_omitted: Parent task has no pre-defined subtasks

# =============================================================================
# RESPONSE / COMPLETION FILE SCHEMAS
# =============================================================================

response_file_schema:
  filename: "{task}.$$.response.md"
  purpose: Milestone or checkpoint while task remains in_progress/
  fields:
    milestone: "Checkpoint name"
    status: "awaiting_input|blocked|continuing"
    summary: "Brief progress update"
    needs: "What is needed to continue (if any)"
    timestamp: "ISO 8601 timestamp"

completion_file_schema:
  filename: "{task}.$$.completion.md"
  purpose: Final completion marker before moving directory to completed/
  fields:
    completed: "ISO 8601 timestamp"
    status: "success|partial|failed"
    summary: "Final outcome"
    artifacts:
      - path: "relative/path/to/output"
        description: "What the artifact contains"

# =============================================================================
# TEMPLATE
# =============================================================================

template: |
  # Request #XXXX: {Title}
  
  **Type:** Standard
  **Priority:** NORMAL
  **Posted:** {ISO 8601 timestamp}
  **Session:** {session_name}  # Optional: omit for ephemeral task
  
  ## Task Description
  
  {Describe what needs to be done. Include context, requirements, and any
  constraints the Worker should know about.}
  
  ## Task Commands
  
  ```bash
  # Commands to execute (optional - omit section if Worker should decide)
  {command_1}
  {command_2}
  ```
  
  ## Expected Response
  
  {Describe what the Worker should return. Be specific about format,
  content, and any files that should be created.}
  
  ## Notes
  
  {Optional: Additional context, related tasks, known issues.}

# =============================================================================
# VALIDATION RULES
# =============================================================================

validation:
  filename_matches_title:
    rule: XXXX in filename must match #XXXX in title
    severity: error

  required_sections_present:
    rule: Title, Type, Priority, Posted, Description, Expected Response must exist
    severity: error
  
  valid_type:
    rule: Type must be one of allowed_values
    severity: error
  
  valid_priority:
    rule: Priority must be one of allowed_values
    severity: error
  
  valid_timestamp:
    rule: Posted must be valid ISO 8601 format
    severity: error
  
  description_not_empty:
    rule: Task Description section must have content
    severity: error
  
  expected_response_not_empty:
    rule: Expected Response section must have content
    severity: warning

# =============================================================================
# EXAMPLES
# =============================================================================

examples:
  minimal:
    filename: req_0042_any_system_info.md
    content: |
      # Request #0042: System Information Report
      
      **Type:** Standard
      **Priority:** NORMAL
      **Posted:** 2025-12-19T15:30:00-06:00
      
      ## Task Description
      
      Gather basic system information for documentation purposes.
      
      ## Task Commands
      
      ```bash
      uname -a
      df -h
      ```
      
      ## Expected Response
      
      System details in markdown format with command outputs.

  full_featured:
    filename: req_0043_librarian_yaml_review.md
    content: |
      # Request #0043: YAML to Markdown Review
      
      **Type:** Research
      **Priority:** HIGH
      **Posted:** 2025-12-19T10:00:00-06:00
      **Discrete:** true
      
      ## Entry Criteria
      
      - All YAML files in target directory exist
      - Previous migration task completed
      
      ## Task Description
      
      Review all YAML files that were converted from Markdown as part of
      the documentation migration. Verify:
      1. YAML syntax is valid
      2. All content from original MD preserved
      3. Structure follows schema conventions
      
      ## Task Commands
      
      ```bash
      find ~/Documents/AI/ai_general/instructions -name "*.yml" -exec yamllint {} \;
      ```
      
      ## Expected Response
      
      Summary report listing:
      - Files reviewed
      - Validation results per file
      - Any issues found with severity
      - Recommended fixes
      
      ## Exit Criteria
      
      - All files validated
      - No critical errors remaining
      - Report written to responses/
      
      ## Notes
      
      If issues found, create follow-up tasks for fixes.

# =============================================================================
# REFERENCES
# =============================================================================

references:
  protocol: protocol_taskCoordination_latest.yml
  response_schema: See protocol file_formats.response_file section
  error_schema: See protocol file_formats.error_file section
