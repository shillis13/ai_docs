# Task Coordination Protocol v7.0

**Version:** 7.0  
**Date:** 2025-12-13  
**Status:** active  
**Supersedes:** v6.0

## Summary of Changes from v6.0

| Aspect | v6.0 | v7.0 |
|--------|------|------|
| Response types | `response.md` (generic) | `.response.md` (milestone) vs `.completion.md` (final) |
| Subtask refs | Not specified | Symlinks to completed child task dirs |
| Orchestration | Implicit | Explicit multi-level hierarchy documented |
| Claim format | `claimed_{ts}_{pid}_` | Unchanged (retained for audit trail) |

---

## Core Concepts

### Directory States
```
to_execute/    →    in_progress/    →    completed/
                                    →    error/
```

- **staged/** - Pre-pipeline holding (bundles not yet released)
- **to_execute/** - Ready for workers to claim
- **in_progress/** - Active work (claimed)
- **completed/** - Successfully finished
- **error/** - Failed tasks with error reports

### Directory-Always Model
Tasks are ALWAYS directories from creation:
```
to_execute/
└── req_1001_task/
    └── req_1001_task.md
```

---

## Claiming Mechanism

### Claim Format
Directory prefix: `claimed_{timestamp}_{pid}_`

```bash
# Before claim
to_execute/req_1001_task/

# After claim (atomic mv)
in_progress/claimed_20251213T143022_12345_req_1001_task/
```

### Claim Contract
- **Unclaimed:** Task dir exists in `to_execute/`
- **Claimed:** Task dir in `in_progress/` with claim prefix
- **Atomic:** First successful `mv` to `in_progress/` owns it
- **Collision-free:** Timestamp + PID ensures uniqueness

---

## Response Files (NEW in v7.0)

### Two Response Types

| File Pattern | Purpose | When Created |
|--------------|---------|--------------|
| `{task}.{pid}.response.md` | Milestone/interim report | Worker hits checkpoint, needs input, or reports progress |
| `{task}.{pid}.completion.md` | Final completion marker | Task fully done |

### Response File Location
Inside the task directory:
```
in_progress/claimed_20251213_12345_req_1001_task/
├── req_1001_task.md              # Original task definition
├── req_1001_task.12345.response.md   # Milestone report (may have multiple)
└── (artifacts)

completed/claimed_20251213_12345_req_1001_task/
├── req_1001_task.md
├── req_1001_task.12345.response.md   # Historical milestones
├── req_1001_task.12345.completion.md # Final completion
└── (artifacts)
```

### Multiple Responses
For multiple milestones, use sequence numbers:
```
req_1001_task.12345.response_001.md
req_1001_task.12345.response_002.md
req_1001_task.12345.completion.md
```

---

## Subtask Management (NEW in v7.0)

### Subtask Creation
When a worker decomposes a task, subtasks are created as separate task dirs:

```
in_progress/claimed_20251213_12345_orch_o1_task_t1/
├── orch_o1_task_t1.md           # Parent task
├── orch_o1_task_t1.1.md         # Subtask definition (before delegation)
└── orch_o1_task_t1.2.md         # Subtask definition (before delegation)
```

### Subtask Delegation
Orchestrator creates task dirs under target worker's `to_execute/`:

```bash
# Orchestrator creates and moves subtask
mkdir worker/Tasks/to_execute/orch_o1_task_t1.1/
mv orch_o1_task_t1.1.md worker/Tasks/to_execute/orch_o1_task_t1.1/
```

### Subtask Naming Convention
```
{parent_task}_t{N}           # First-level subtask
{parent_task}_t{N}.{M}       # Second-level subtask
{parent_task}_t{N}.{M}.{P}   # Third-level subtask
```

Example hierarchy:
```
orch_o1_task                 # Root task
├── orch_o1_task_t1          # Subtask 1
│   ├── orch_o1_task_t1.1    # Sub-subtask 1.1
│   └── orch_o1_task_t1.2    # Sub-subtask 1.2
└── orch_o1_task_t2          # Subtask 2
```

---

## Symlinks for Completed Children (NEW in v7.0)

### Purpose
When subtasks complete in worker directories, parent task dir maintains references via symlinks. This allows:
- Traversing full task tree from parent
- Avoiding duplication
- Clean audit trail

### Pattern
```
# Parent task in orchestrator's in_progress
in_progress/claimed_20251213_12345_orch_o1_task/
├── orch_o1_task.md
├── orch_o1_task_t1@ → ../../../claude_cli/Tasks/completed/claimed_..._orch_o1_task_t1/
└── orch_o1_task_t2@ → ../../../codex_cli/Tasks/completed/claimed_..._orch_o1_task_t2/
```

### When to Create Symlinks
- After child task moves to `completed/`
- Before parent task itself moves to `completed/`
- Orchestrator creates symlink, not worker

### Symlink Naming
```
{subtask_name}@              # Symlink indicator (@ suffix is convention)
```

---

## Multi-Level Orchestration

### Hierarchy Model
```
Claude Desktop (top orchestrator)
├── claude_cli [instance A] (worker / sub-orchestrator)
│   ├── claude_cli [instance B] (worker)
│   └── claude_cli [instance C] (worker)
└── codex_cli [instance X] (worker)
```

### Orchestration Flow

1. **Top orchestrator receives task**
2. **Decomposes into subtasks**
3. **Delegates to workers** (creates dirs in worker's `to_execute/`)
4. **Workers claim and execute** (or further decompose)
5. **Workers complete** (create `.completion.md`, move to `completed/`)
6. **Orchestrator receives notification** (file watch, IM, or poll)
7. **Orchestrator creates symlinks** to completed child dirs
8. **Orchestrator completes** own task

### Notification Mechanisms
- **File-based:** Poll `completed/` directories
- **IM-based:** Worker sends message to parent (see ai_comms protocol)
- **Scheduled:** Cron triggers orchestrator to check status

---

## Bundle Support (from v6.0)

Bundles group related phases. Bundle dir contains phase subdirs:
```
req_XXXX_bundle/
├── req_XXXX_bundle.md           # Bundle overview
├── req_XXXXa_phase/
│   └── req_XXXXa_phase.md
└── req_XXXXb_phase/
    └── req_XXXXb_phase.md
```

Bundle moves as unit; phases complete internally.

---

## Session Persistence (from v6.0)

Persistent agents maintain expertise across invocations:

```yaml
# ~/.claude/session_registry.yml
agents:
  librarian-001:
    purpose: "Condensing, chat processing, memory management"
  custodian-001:
    purpose: "Maintenance, cleanup, organization"
  reviewer-001:
    purpose: "Code quality, PR reviews"
```

Launch patterns:
```bash
# Persistent (continues context)
claude --session-id librarian-001 "process chats"

# Ephemeral (fresh)
claude "one-off task"
```

---

## Directory Structure Reference

```yaml
coordination_root/           # e.g., ai_comms/claude_cli/Tasks/
├── staged/                  # Pre-release holding
├── to_execute/              # Ready for claiming
│   └── {task_dir}/
│       └── {task}.md
├── in_progress/             # Active work
│   └── claimed_{ts}_{pid}_{task_dir}/
│       ├── {task}.md
│       ├── {task}.{pid}.response.md      # Milestones
│       ├── {subtask}.md                  # Pending subtasks
│       └── {subtask}@                    # Symlinks to completed
├── completed/               # Done
│   └── claimed_{ts}_{pid}_{task_dir}/
│       ├── {task}.md
│       ├── {task}.{pid}.completion.md
│       └── {subtask}@
└── error/                   # Failed
    └── {task_dir}/
        ├── {task}.md
        └── error_report.md
```

---

## Migration from v6.0

Minimal changes required:
1. **Response files:** Rename `response.md` → `{task}.{pid}.completion.md` for completed tasks
2. **Add response type:** When reporting milestones, use `.response.md` suffix
3. **Symlinks:** Optional - add when orchestrating multi-level tasks

No structural changes to directories or claiming mechanism.

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 7.0 | 2025-12-13 | Response type distinction, symlinks, subtask patterns, orchestration hierarchy |
| 6.0 | 2025-12-11 | Directory-always model, bundle support, session persistence |
| 5.0 | 2025-11-23 | Directory-based with flat-to-folder transition |
| 4.0 | 2025-11-02 | Initial directory-based coordination |
