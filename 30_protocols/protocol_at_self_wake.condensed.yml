# Condensed from: protocol_at_self_wake_latest.yml
# Source: ai_general/docs/30_protocols/protocol_at_self_wake_latest.yml
# Version: 1.0.0 | Status: active | Category: pattern

at_self_wake:
  summary: Desktop Claude schedules AT job to self-prompt after delegating long-running work

  problem: |
    Desktop Claude has no inherent agency between responses.
    After delegating to CLI, Claude only wakes when prompted.
    CLI cannot reliably prompt Desktop due to conversation locks.

  solution: AT job as wake-up alarm for autonomous monitoring loops

  key_insight: |
    AT is Desktop's wake-up alarm, not CLI's doorbell.
    CLI completion isn't urgent enough to force-interrupt.
    Desktop wakes on schedule, checks progress, decides next action.

  implementation:
    set_wake_alarm: |
      cat << 'EOF' | at now + 3 minutes
      /path/to/send_prompt.sh claude-desktop "AT wake-up: Check status" --force --submit
      EOF

    on_wake_check:
      - Is tmux session still alive?
      - Has progress been made (new/updated files)?
      - Is worker stuck waiting for something?

    decision_tree:
      worker_running_and_progressing: Set another AT
      worker_complete: Clean up, report results
      worker_stuck: Intervene or escalate

  prerequisites:
    - send_prompt.sh with --force flag (bypasses busy/lock checks)
    - AT daemon running (launchd on macOS)
    - Desktop Claude app accessible via AppleScript

  pattern_flow:
    1: Desktop Claude creates task specification
    2: Desktop launches CLI worker in tmux (-t flag)
    3: Desktop sets AT job for N minutes in future
    4: Desktop goes to sleep (stops responding)
    5: AT fires -> send_prompt.sh --force injects wake message
    6: Desktop wakes, checks worker status
    7: Repeat 3-6 or wrap up

  example:
    delegation: claude_cli.sh -t -a -s my_worker -A librarian "Execute task req_XXXX"
    set_alarm: |
      cat << 'EOF' | at now + 5 minutes
      send_prompt.sh claude-desktop "AT wake-up: Check my_worker status" --force --submit
      EOF
    wake_check:
      check_session: tmux list-sessions | grep my_worker
      check_output: ls -la /path/to/output/
      capture_activity: tmux capture-pane -t my_worker -p -S -50

  advantages:
    - No conversation lock bypass needed from worker side
    - Predictable wake intervals
    - Desktop maintains oversight without blocking
    - Worker runs fully autonomous
    - Human not required in loop

  limitations:
    - AT granularity is 1 minute minimum
    - Requires AT daemon running
    - send_prompt.sh --force must work reliably
    - No interrupt for urgent issues (scheduled wake only)

  related:
    - send_prompt.sh (--force flag addition)
    - CLI coordination protocol
    - Desktop Claude context preservation rules

  future_enhancements:
    - Priority channel for urgent worker alerts
    - Adaptive AT intervals based on task complexity
    - Multiple concurrent worker monitoring
    - Escalation to user if worker fails repeatedly

  metadata:
    maintainer: PianoMan
