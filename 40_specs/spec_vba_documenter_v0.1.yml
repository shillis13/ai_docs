---
# VBA Documenter Design Specification
# Version: 0.1.0 (Draft for Review)
# Author: Claude (Desktop)
# Date: 2025-12-17
# Status: DRAFT - Pending Design Review

metadata:
  title: VBA Documenter Tool
  purpose: Extract VBA documentation from Excel files or exported modules, generate Confluence-compatible output
  output_format: Confluence Wiki Markup (also supports Markdown)
  target_location: ~/bin/python/src/ai_utils/vba_documenter/

## Overview

goals:
  - Extract VBA code from Excel files (.xlsm, .xlsb, .xls)
  - Parse exported VBA modules (.bas, .cls, .frm, .frx)
  - Generate structured API documentation
  - Output Confluence-compatible wiki markup with TOC
  - Support both "tool documentation" (from Excel files) and "framework API docs" (from directories)

use_cases:
  excel_tool:
    description: Document an Excel-based application/tool
    input: Single Excel file with VBA modules
    output: Complete tool documentation with TOC, overview, and API reference
  framework_api:
    description: Document a VBA framework/library
    input: Directory of exported VBA modules
    output: API reference documentation with classes, modules, and usage examples

## Architecture

components:
  vba_extractor:
    purpose: Extract VBA source from Excel files
    library: oletools (olevba module)
    handles:
      - .xlsm (Excel Macro-Enabled Workbook)
      - .xlsb (Excel Binary Workbook)
      - .xls (Legacy Excel)
    outputs: Dict of module_name -> source_code

  vba_parser:
    purpose: Parse VBA source into structured documentation
    approach: Regex + state machine (VBA syntax is relatively simple)
    extracts:
      - module_type: (Standard Module, Class Module, UserForm, Document Module)
      - declarations: (Option Explicit, Public variables, Private variables, Constants)
      - procedures: (Sub, Function, Property Get/Let/Set)
      - procedure_metadata:
          - name
          - visibility (Public/Private)
          - parameters (name, type, optional, default_value)
          - return_type (for Functions)
          - description (from comments)
      - doc_comments: Parses preceding comment blocks as documentation
    
  doc_generator:
    purpose: Generate Confluence wiki markup from parsed data
    features:
      - Table of Contents generation
      - Module hierarchy
      - Class relationship diagrams (optional, via Mermaid)
      - Cross-references between classes
      - Example code blocks with syntax highlighting
    
  confluence_formatter:
    purpose: Format output for Confluence
    formats:
      wiki_markup: Traditional Confluence wiki syntax
      storage_format: XHTML-based storage format (for API uploads)
      markdown: Fallback for preview/other systems

## Data Model

vba_module:
  properties:
    - name: str
    - module_type: enum[STANDARD, CLASS, USERFORM, DOCUMENT]
    - source_file: Optional[Path]  # For exported modules
    - declarations: List[Declaration]
    - procedures: List[Procedure]
    - doc_header: Optional[str]  # Module-level documentation

declaration:
  properties:
    - name: str
    - decl_type: enum[VARIABLE, CONSTANT, TYPE, ENUM]
    - data_type: str
    - visibility: enum[PUBLIC, PRIVATE]
    - initial_value: Optional[str]
    - doc_comment: Optional[str]

procedure:
  properties:
    - name: str
    - proc_type: enum[SUB, FUNCTION, PROPERTY_GET, PROPERTY_LET, PROPERTY_SET]
    - visibility: enum[PUBLIC, PRIVATE]
    - parameters: List[Parameter]
    - return_type: Optional[str]  # For Functions
    - doc_comment: Optional[str]
    - example_usage: Optional[str]
    - source_lines: Tuple[int, int]  # Line range in source

parameter:
  properties:
    - name: str
    - data_type: str
    - is_optional: bool
    - is_byref: bool  # Default True for VBA
    - is_paramarray: bool
    - default_value: Optional[str]

## VBA Comment Documentation Convention

doc_format:
  description: >
    VBA doesn't have native doc comments like Python docstrings.
    We'll support a simple convention similar to VB XML comments.
  
  patterns:
    single_line: "' Description text"
    block_start: "''"
    description: "'' Description text"
    param: "'' @param paramName Description"
    returns: "'' @returns Description"
    example: "'' @example"
    example_code: "''   Code line"
    see_also: "'' @see OtherProcedure"
    deprecated: "'' @deprecated Use NewProcedure instead"

  example_documented_procedure: |
    ''
    '' Calculates the compound interest for a given principal.
    ''
    '' @param principal The initial investment amount
    '' @param rate Annual interest rate (as decimal, e.g., 0.05 for 5%)
    '' @param periods Number of compounding periods
    '' @param compoundsPerYear Optional. Compounding frequency (default 12 for monthly)
    '' @returns The total amount after interest
    '' @example
    ''   Dim result As Double
    ''   result = CalculateCompoundInterest(1000, 0.05, 5)
    '' @see CalculateSimpleInterest
    ''
    Public Function CalculateCompoundInterest( _
        principal As Double, _
        rate As Double, _
        periods As Integer, _
        Optional compoundsPerYear As Integer = 12) As Double
        
        CalculateCompoundInterest = principal * (1 + rate / compoundsPerYear) ^ (compoundsPerYear * periods)
    End Function

## Confluence Output Structure

tool_documentation_template:
  sections:
    - title: "{Tool Name} Documentation"
      content: |
        Generated from: {source_file}
        Generated on: {timestamp}
        
    - title: "Table of Contents"
      content: "{auto-generated TOC macro}"
      
    - title: "Overview"
      content: "Tool description (from module-level comments or README)"
      
    - title: "Quick Start"
      content: "Basic usage examples"
      
    - title: "API Reference"
      subsections:
        - title: "Classes"
          content: "Class modules with properties and methods"
        - title: "Modules"
          content: "Standard modules with public procedures"
        - title: "Global Variables"
          content: "Public declarations across modules"
        - title: "Constants & Enums"
          content: "Public constants and enumerations"
          
    - title: "Examples"
      content: "Extended usage examples"
      
    - title: "Dependencies"
      content: "Required references and dependencies"

framework_api_template:
  sections:
    - title: "{Framework Name} API Reference"
    - title: "Table of Contents"
    - title: "Module Index"
      content: "Alphabetical listing of all modules"
    - title: "Class Reference"
      content: "Detailed class documentation"
    - title: "Module Reference"
      content: "Standard module documentation"
    - title: "Type Definitions"
    - title: "Constants & Enums"

## CLI Interface

commands:
  document:
    description: Generate documentation from VBA source
    usage: |
      vba-doc document <source> [options]
      
      source: Excel file (.xlsm, .xlsb) or directory path
    options:
      --output, -o: Output file path (default: stdout)
      --format, -f: Output format [confluence|markdown|json] (default: confluence)
      --template, -t: Documentation template [tool|api|custom] (default: auto-detect)
      --title: Override document title
      --toc: Include table of contents (default: true)
      --examples: Include example code blocks (default: true)
      --private: Include private members (default: false)

  extract:
    description: Extract VBA source without generating documentation
    usage: |
      vba-doc extract <excel_file> [options]
    options:
      --output-dir, -o: Directory for extracted modules (default: ./vba_modules/)
      --format: Export format [bas|txt] (default: bas)

  validate:
    description: Validate VBA documentation comments
    usage: |
      vba-doc validate <source>
    output: Report of undocumented public members

## Implementation Plan

phase_1_core:
  name: Core Parser & Extractor
  deliverables:
    - vba_extractor.py: Extract from Excel files using oletools
    - vba_parser.py: Parse VBA source into data model
    - models.py: Data classes for VBA structures
  test_coverage:
    - Unit tests for parsing individual constructs
    - Integration test with sample Excel file

phase_2_generator:
  name: Documentation Generator
  deliverables:
    - confluence_generator.py: Generate Confluence wiki markup
    - markdown_generator.py: Generate Markdown (for preview/alternatives)
    - toc_generator.py: Table of Contents logic
  test_coverage:
    - Output format validation
    - TOC structure verification

phase_3_cli:
  name: CLI Interface & Integration
  deliverables:
    - cli.py: Click-based CLI
    - __main__.py: Entry point
    - templates/: Confluence templates
  test_coverage:
    - CLI argument parsing
    - End-to-end integration tests

phase_4_enhancements:
  name: Advanced Features (Optional)
  deliverables:
    - mermaid_diagrams.py: Class relationship diagrams
    - confluence_api.py: Direct Confluence upload via REST API
    - watch_mode: Auto-regenerate on source changes

## Dependencies

required:
  - oletools: VBA extraction from Office files
  - click: CLI framework
  - pyyaml: Configuration and data serialization
  - jinja2: Template rendering

optional:
  - atlassian-python-api: Direct Confluence integration
  - rich: Enhanced CLI output

## Directory Structure

location: ~/bin/python/src/ai_utils/vba_documenter/
structure:
  vba_documenter/
  ├── __init__.py
  ├── __main__.py         # CLI entry point
  ├── cli.py              # Click CLI definitions
  ├── models.py           # Data classes
  ├── extractors/
  │   ├── __init__.py
  │   ├── excel_extractor.py   # oletools integration
  │   └── file_extractor.py    # .bas/.cls file reading
  ├── parsers/
  │   ├── __init__.py
  │   └── vba_parser.py        # VBA syntax parser
  ├── generators/
  │   ├── __init__.py
  │   ├── base.py              # Abstract generator
  │   ├── confluence.py        # Confluence wiki markup
  │   └── markdown.py          # Markdown output
  ├── templates/
  │   ├── confluence_tool.j2
  │   ├── confluence_api.j2
  │   └── markdown_default.j2
  └── tests/
      ├── __init__.py
      ├── conftest.py          # Pytest fixtures
      ├── test_extractor.py
      ├── test_parser.py
      ├── test_generator.py
      └── fixtures/
          ├── sample_tool.xlsm
          ├── sample_module.bas
          └── sample_class.cls

## Review & Implementation Process

workflow:
  1_design_review:
    actor: Codex MCP
    task: Review this spec for completeness, edge cases, technical feasibility
    deliverable: Review comments and suggested improvements
    
  2_implementation:
    actor: Claude CLI (via Task Coordination v4.0)
    tasks:
      - Implement Phase 1 (core parser)
      - Implement Phase 2 (generators)
      - Implement Phase 3 (CLI)
    pattern: Iterative with Desktop Claude oversight
    
  3_testing:
    actor: Claude CLI
    tasks:
      - Create test fixtures (sample VBA files)
      - Write unit tests
      - Write integration tests
    validation: Codex MCP reviews test coverage
    
  4_documentation:
    actor: Claude Desktop
    task: Create README, usage examples, update tool registry

open_questions:
  - Should we support VBA7 (64-bit) specific syntax?
  - Include support for MSForms UserForm parsing?
  - How to handle WithEvents and Implements keywords?
  - Should we extract and document API/Type Library references?
