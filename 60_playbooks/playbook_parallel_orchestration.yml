---
metadata:
  title: Parallel Worker Orchestration Playbook
  version: 1.0.0
  created: 2025-12-10
  maintainer: PianoMan
  status: active
  category: playbook

summary: |
  How to deploy multiple Claude CLI workers in parallel with AT self-wake 
  monitoring. Desktop Claude orchestrates without doing the work.

when_to_use:
  - Large task divisible into independent subtasks
  - Same operation across multiple directories/files
  - Work that benefits from parallelism
  - Estimated time >10 minutes for single worker

prerequisites:
  - claude_cli.sh wrapper with -t, -a, -A flags
  - send_prompt.sh with --force flag
  - AT daemon running (launchctl on macOS)
  - Agent profiles in ~/.claude/agents.json

steps:
  1_design_partitioning:
    action: Divide work into independent units
    example: "7 directories â†’ 7 workers"
    rule: "Units must not have write conflicts"

  2_select_agent:
    action: Choose appropriate agent for task type
    options:
      librarian: "Knowledge work, documentation, condensation"
      custodian: "File reorganization, structure validation"
      dev-lead: "Code review, task coordination"
      ops: "Process monitoring, system tasks"

  3_launch_workers:
    pattern: |
      for unit in $UNITS; do
        rm -f /tmp/claude_cli.*.sh  # Prevent temp file collision
        sleep 2  # Stagger launches
        claude_cli.sh -t -a -s worker_$unit -A $AGENT "$PROMPT for $unit"
      done
    flags:
      -t: "Detached tmux session (survives parent exit)"
      -a: "Auto-approve operations"
      -s NAME: "Named session for monitoring"
      -A AGENT: "Agent profile"

  4_set_wake_alarm:
    pattern: |
      cat << 'EOF' | at now + N minutes
      send_prompt.sh claude-desktop "AT wake-up: Check workers" --force --submit
      EOF
    interval_guidance:
      simple_tasks: "3-5 minutes"
      complex_tasks: "5-10 minutes"
      long_running: "10-15 minutes"

  5_on_wake_check:
    commands:
      sessions: "tmux list-sessions | grep worker_"
      progress: "ls output_dir/ | wc -l"
      stuck: "tmux capture-pane -t worker_X -p -S -20"
    decision:
      all_exited_complete: "Verify outputs, wrap up"
      all_exited_partial: "Launch cleanup worker"
      still_running: "Set another AT, sleep"
      stuck: "Investigate, potentially restart"

  6_cleanup:
    actions:
      - "Kill any stale tmux sessions"
      - "Move task files to completed/"
      - "Verify all expected outputs exist"
      - "Quality-check sample outputs"

monitoring_commands:
  list_sessions: "tmux list-sessions | grep $PREFIX"
  check_output: "tmux capture-pane -t $SESSION -p -S -50"
  count_progress: "ls $OUTPUT_DIR/*.yml | wc -l"
  kill_session: "tmux kill-session -t $SESSION"

common_issues:
  temp_file_collision:
    symptom: "mkstemp failed on /tmp/claude_cli.XXXXXX.sh"
    fix: "rm -f /tmp/claude_cli.*.sh before each launch"
  
  worker_exits_early:
    symptom: "Session gone but work incomplete"
    fix: "Launch targeted cleanup worker for remaining items"
  
  codex_validation_timeout:
    symptom: "Worker stuck waiting for Codex"
    fix: "Kill stale val_* sessions, worker will retry or skip"

example_deployment:
  task: "Condense 54 docs across 7 directories"
  workers: 7
  agent: librarian
  time: "~25 minutes"
  result: "72% reduction, all validated"
  see: "60_playbooks/parallel_orchestration_case_study.yml"
